<div class="row">
    <div id="validation_error">
    </div>
    <h4>Game: <%=Game.name%>, Your: <%=AppState.username%></h4>
    <div class="col-lg-7">
        <a href="/" class="btn btn-lg btn-primary btn-block" id="leave_game">Leave game</a>
        <canvas id="main_canvas"></canvas>
    </div>
    <div class="col-lg-5">
        <ul id="chat_messages">
            wait...
        </ul>
        <form id="chat-form">
            <input id='message_text' name='text' type="text" />
            <input name='game' type="hidden" value="<%=Game.id%>" />
            <a href="/" class="btn btn-lg btn-primary btn-block" id="send_message">send</a>
        </form>
    </div>
</div>
<script>
    $(document).ready( function () {
        draw_map(<%=Game.mapData%>);
        start_websocket("<%=AppState.sid%>", "<%=AppState.username%>");

        var onbuttondown = function(e) {
            var key = e.type == "keydown" ? e.keyCode : KEY_MOUSE,
                offset = $(this).offset();
            var x = key == KEY_MOUSE ? e.clientX - offset.left : 0,
                y = key == KEY_MOUSE ? e.clientY - offset.top : 0;
            if (!(key in pressed_keys))
                return;
            pressed_keys[key] = true;
            if (!pressed)
                key_hold("<%=AppState.sid%>", x, y);
        };
        var onbuttonup = function(e) {
            var key = e.type == "keyup" ? e.keyCode : KEY_MOUSE;
            if (!(key in pressed_keys))
                return;
            pressed = pressed_keys[key] = false;
            for (i in pressed_keys)
                pressed = pressed || pressed_keys[i];
        };
        document.onkeydown = onbuttondown
        document.onkeyup = onbuttonup
        $('#main_canvas').mousemove(function (e)
        {
            var offset = $(this).offset();
            mouse_x = e.clientX - offset.left,
            mouse_y = e.clientY - offset.top;
        });
        $('#main_canvas').mousedown(onbuttondown);
        $(document).mouseup(onbuttonup);
    })
</script>
